let genreX="",genreID="",saveInfo=[],minMinutes=10,maxMinutes=121;const body=$("body"),generateButton=$(".generateButton"),promptForm=$(".promptForm"),playlistPromptForm=$(".playlistPromptForm"),closeBtn=$(".closeBtn"),titlePlaylist=$(".playlistTitle"),durationPlaylist=$(".playlistDuration"),genrePlaylist=$(".genres"),userPlaylist=$(".userPlaylist"),buttonsRow=$(".buttonsRow"),modalTitle=$(".hinner"),saveButton=document.querySelector("#save"),generateNewButton=$("#generateNew"),generateBtn=$(".submitBtn");promptForm.hide(),userPlaylist.hide(),buttonsRow.hide();class Playlist{constructor(e,t,a,n,r){this.name=e,this.duration=t,this.durationMinutes=a,this.trackList=n,this.genre=r}logInfo(){Object.values(this).forEach(e=>{console.log(e)})}}class Track{constructor(e,t,a,n,r,s,o,i){this.name=e,this.duration=t,this.artist=a,this.id=n,this.href=r,this.album=s,this.external_urls=o,this.releaseDate=i}logInfo(){Object.values(this).forEach(e=>{console.log(e)})}}let token="";const clientId="8f62dc31962f42fabe1974961a756d45",clientSecret="ca84a1572ec940789947e1428e236a11",_getToken=async()=>{const e=await fetch("https://accounts.spotify.com/api/token",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Authorization:"Basic "+btoa(clientId+":"+clientSecret)},body:"grant_type=client_credentials"}),t=await e.json();return token=t.access_token,t.access_token};function promptFormShow(){promptForm.show(1e3),generateBtn.on("click",e=>{if(e.preventDefault(),""===titlePlaylist.val()||""===durationPlaylist.val()||isNaN(durationPlaylist.val())||durationPlaylist.val()<minMinutes||durationPlaylist.val()>=maxMinutes)return void alert("Please enter valid inputs into the fields.");generatePlaylist(titlePlaylist.val(),durationPlaylist.val(),genrePlaylist.val()),playlistPromptForm.hide(1e3)}),closeBtn.on("click",e=>{promptFormHide()})}function promptFormHide(){promptForm.hide(1e3)}function generatePlaylist(e,t,a){const n=[];let r=0,s=1e3*(60*t);userPlaylist.show(1e3);let o=[],i=[];genreX=a,fetchTracks().then(t=>{t.items.forEach(e=>{const{track:{name:t,duration_ms:a,artists:r,id:s,href:o,album:i,external_urls:l}}=e,c=moment(e.track.album.release_date).format("dddd, MMMM Do YYYY"),u=new Track(t,a,r[0].name,s,o,i,l,c);n.push(u)});const l=shuffleArray([...n]);for(var c=0;c<l.length;c++){let e=l[c].duration;if((r+=e)>=s)break;o.push(l[c])}userPlaylist.html("");const u=Math.floor(moment.duration(r).asMinutes());modalTitle.html(`${e}<span class="listDetails"> <span class="greenSep">|</span> ${u} minutes long <span class="greenSep">|</span> ${o.length} Track(s).</span>`);let d=new Playlist(e,r,u,o,a);i.push(d),saveInfo=i,o.forEach((e,t)=>{const a=e.id,n=Math.floor(moment.duration(e.duration).asMinutes()),r=$(`\n            <div class="trackElement">\n                <iframe src="https://open.spotify.com/embed/track/${a}" width="100%" height="80" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"></iframe>\n                <div class="trackDetails">\n                    ${t+1}.\n                    <marquee><a href="/">${e.name}</a> by ${e.artist} <span class="greenSep">|</span> ${n} Minute(s) <span class="greenSep">|</span> Published on ${e.releaseDate}</marquee>\n                </div>\n            </div>\n            `);userPlaylist.append(r)})}),buttonsRow.show(1e3)}async function fetchTracks(){var e=shuffleArray([...["37i9dQZEVXbMDoHDwVN2tF","37i9dQZEVXbLRQDuF5jeBp","37i9dQZEVXbLiRSasKsNU9"]])[0];const t=await fetch(`https://api.spotify.com/v1/playlists/${function(t){switch(genreX){case"Random":return genreID=e;case"Rap":return genreID="37i9dQZF1DX0XUsuxWHRQd";case"Rock":return genreID="37i9dQZF1DXcF6B6QPhFDv";case"Pop":return genreID="37i9dQZF1DXarRysLJmuju";case"R&B":return genreID="37i9dQZF1DX4SBhb3fqCJd";case"Country":return genreID="37i9dQZF1DX1lVhptIYRda";case"Metal":return genreID="37i9dQZF1DWTcqUzwhNmKv";case"Metalcore":return genreID="79QHayucQm6M4wUlUbhQNQ";case"Hip Hop":return genreID="0FAb3s3yJArWnikZbEOO9p"}return genreID}()}/tracks?offset=0&limit=50`,{method:"GET",headers:{Authorization:"Bearer "+token}});return await t.json()}function shuffleArray(e){let t,a=e.length;for(;0!=a;)t=Math.floor(Math.random()*a),a--,[e[a],e[t]]=[e[t],e[a]];return e}_getToken(),generateButton.on("click",e=>{promptFormShow()}),generateNewButton.on("click",e=>{userPlaylist.hide(1e3),buttonsRow.hide(1e3),modalTitle.html("Generate New Playlist Form"),playlistPromptForm.show(1e3)}),saveButton&&saveButton.addEventListener("click",async e=>{const t=saveInfo[0].name,a=saveInfo[0].genre,n=saveInfo[0].trackList,r=saveInfo[0].durationMinutes,s=saveInfo[0].duration,o=await fetch("/api/playlist/",{method:"POST",body:JSON.stringify({name:t,genre:a,track_list:n,reqDuration:r,realDuration:s}),headers:{"Content-Type":"application/json"}}),i=await o.json();console.log(i),o.ok?document.location.replace("/dashboard"):alert("Failed to create project")});const trackElems=document.querySelectorAll(".trackElem");trackElems.forEach(e=>{e.addEventListener("click",async function(t,a){let n=t.target.getAttribute("data-trackID"),r=t.target.parentElement.id,s=e.querySelector(".trackDuration").innerHTML;const o=await fetch(`https://api.spotify.com/v1/tracks/${n}`,{method:"GET",headers:{Authorization:"Bearer "+token}}),i=await o.json();window.location.href=`/track?=${i.name}`,localStorage.setItem("Selected Track",JSON.stringify(i)),localStorage.setItem("Track Genre",r),localStorage.setItem("Track Duration",s)})});